<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THDX ‚Ä¢ Sepolia ‚Üí Stable Bridge (v5 SafeSend)</title>
<meta name="theme-color" content="#0b1220" />
<style>
  :root{--bg:#0b1220;--card:#121a2a;--muted:#9aa6b2;--stroke:#22304a;--text:#e6edf3;--g1:#6ee7ff;--g2:#7c5cff;--ok1:#16a34a;--ok2:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;min-height:100svh;display:grid;place-items:center;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
  .wrap{width:min(620px,94vw)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
  h1{margin:0 0 8px;font-size:22px}.sub{margin:0 0 14px;color:var(--muted)}
  label{display:block;margin:10px 0 6px;color:#cfe3ff;font-weight:600;font-size:13px}
  select,input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--stroke);background:#0f1625;color:#fff;font-size:14px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{width:100%;padding:12px;border:0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;transition:.2s;margin-top:10px}
  .primary{background:linear-gradient(90deg,var(--g1),var(--g2))}.ok{background:linear-gradient(90deg,#16a34a,#22c55e)}
  .muted{background:#1b263b}button:disabled{opacity:.55;cursor:not-allowed}
  pre{margin-top:12px;white-space:pre-wrap;background:#0f1625;border:1px solid var(--stroke);border-radius:10px;padding:12px;min-height:120px;font-size:12.5px}
  #toasts{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:10px;z-index:9999}
  .toast{background:#1c253b;color:#e6e8ff;border-left:5px solid var(--g2);padding:10px 12px;border-radius:10px;box-shadow:0 6px 12px rgba(0,0,0,.35);font-size:13px}
  .error{border-left-color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>THDX ‚Ä¢ Mini Bridge</h1>
    <div class="sub">Sumber: <b>Sepolia</b> ‚Üí Tujuan: <b>Stable Testnet</b></div>

    <label>Jenis Bridge</label>
    <select id="bridgeType">
      <option value="lz">LayerZero OFT (rekomendasi)</option>
      <option value="wh">Wormhole (opsional)</option>
    </select>

    <!-- LayerZero OFT -->
    <div id="lzBox">
      <div class="grid2">
        <div>
          <label>Token (Sepolia)</label>
          <input id="lzToken" value="0xc4DCC311c028e341fd8602D8eB89c5de94625927" />
        </div>
        <div>
          <label>OFT Adapter (Sepolia)</label>
          <input id="lzAdapter" value="0xc099cD946d5efCC35A99D64E808c1430cEf08126" />
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>dstEid (Stable)</label>
          <input id="lzDstEid" value="40374" />
        </div>
        <div>
          <label>Decimals</label>
          <input id="lzDecimals" value="6" />
        </div>
      </div>
    </div>

    <!-- Wormhole (opsional) -->
    <div id="whBox" style="display:none">
      <div class="grid2">
        <div>
          <label>Token (Sepolia)</label>
          <input id="whToken" placeholder="0x..." />
        </div>
        <div>
          <label>Dec</label>
          <input id="whDec" value="6" />
        </div>
      </div>
      <div class="grid2">
        <div>
          <label>TokenBridge (Sepolia)</label>
          <input id="whBridge" value="0x6c5aAE4622B835058A41879bA5e128019B9047d6" />
        </div>
        <div>
          <label>dst Wormhole ChainID</label>
          <input id="whDst" placeholder="mis: 31041" />
        </div>
      </div>
      <div class="sub" style="margin-top:6px">Note: Wormhole testnet sering whitelist token ‚Üí gunakan OFT bila revert.</div>
    </div>

    <div class="grid2">
      <div>
        <label>Jumlah</label>
        <input id="amount" placeholder="misal: 10" inputmode="decimal" />
      </div>
      <div>
        <label>Penerima</label>
        <input id="recipient" placeholder="0x..." />
      </div>
    </div>

    <div class="grid2">
      <button id="btnConnect" class="primary">üîå Connect Wallet</button>
      <button id="btnApprove" class="muted" disabled>‚úÖ Approve</button>
    </div>
    <button id="btnBridge" class="ok" disabled>üöÄ Bridge Now</button>

    <pre id="log">log siap...</pre>
  </div>
</div>
<div id="toasts"></div>

<script>
(function loadEthers(){
  const add=(src,cb)=>{const s=document.createElement('script');s.src=src;s.onload=cb;s.onerror=()=>console.error('Gagal load',src);document.body.appendChild(s)};
  if(typeof window.ethers==="undefined"){
    add("https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js", initTHDX);
  } else initTHDX();
})();

function initTHDX(){
  const CHAIN_SEPOLIA = 11155111;
  const $ = (q)=>document.querySelector(q);
  const toast = (m,type)=>{const d=document.createElement('div');d.className=`toast ${type||""}`;d.textContent=m;$("#toasts").appendChild(d);setTimeout(()=>d.remove(),3500);}
  const log = (m)=>{const el=$("#log"); el.textContent += (el.textContent?"\n":"")+m; el.scrollTop=el.scrollHeight; console.log(m);}

  let provider, signer, me;

  const addrTo32 = (addr)=>"0x"+addr.toLowerCase().replace(/^0x/,"").padStart(64,"0");
  const parseAmount = (v,dec)=>{
    if(v===undefined||v===null||v==="") throw new Error("Jumlah kosong.");
    if(isNaN(Number(v))) throw new Error("Jumlah tidak valid.");
    return ethers.utils.parseUnits(String(v), dec);
  };

  const ERC20_ABI = ["function approve(address spender,uint256 value) returns(bool)"];
  const OFT_ABI = [
    "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool)view returns(uint256 nativeFee,uint256 zroFee)",
    "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address)payable"
  ];

  async function ensureSepolia(){
    const net = await provider.getNetwork();
    if(net.chainId === CHAIN_SEPOLIA) return;
    log(`‚ö†Ô∏è Bukan di Sepolia (chainId=${net.chainId}). Switching...`);
    await provider.send("wallet_switchEthereumChain", [{ chainId: "0xaa36a7" }]);
  }

  // UI mode switch
  $("#bridgeType").onchange = ()=>{
    const mode=$("#bridgeType").value;
    $("#lzBox").style.display=(mode==="lz")?"block":"none";
    $("#whBox").style.display=(mode==="wh")?"block":"none";
  };

  // CONNECT
  $("#btnConnect").onclick = async ()=>{
    try{
      if(!window.ethereum) throw new Error("Buka di MetaMask/OKX/Trust browser.");
      provider = new ethers.providers.Web3Provider(window.ethereum,"any");
      await provider.send("eth_requestAccounts",[]);
      signer = provider.getSigner(); me = await signer.getAddress();
      await ensureSepolia();
      $("#recipient").value = me;
      $("#btnApprove").disabled = false;
      $("#btnBridge").disabled = false;
      const net = await provider.getNetwork();
      log(`‚úÖ Connected: ${me}\nChain: ${net.chainId}`);
    }catch(e){ log("‚ùå Connect error: "+(e.message||e)); toast("Gagal connect","error"); }
  };

  // APPROVE
  $("#btnApprove").onclick = async ()=>{
    try{
      await ensureSepolia();
      const mode=$("#bridgeType").value;
      let token, spender, decimals;
      if(mode==="lz"){ token=$("#lzToken").value.trim(); spender=$("#lzAdapter").value.trim(); decimals=parseInt($("#lzDecimals").value||"6",10); }
      else { token=$("#whToken").value.trim(); spender=$("#whBridge").value.trim(); decimals=parseInt($("#whDec").value||"6",10); }
      const amountLD=parseAmount($("#amount").value.trim(),decimals);
      const erc20=new ethers.Contract(token,ERC20_ABI,signer);
      log(`üßæ Approve ${mode.toUpperCase()}...`);
      const tx=await erc20.approve(spender,amountLD);
      log(`‚è≥ Approve TX: ${tx.hash}`); await tx.wait();
      log("‚úÖ Approve sukses!");
    }catch(e){ log("‚ùå Approve error: "+(e.reason||e.message||e)); toast("Approve gagal","error"); }
  };

  // BRIDGE
  $("#btnBridge").onclick = async ()=>{
    try{
      await ensureSepolia();
      const mode=$("#bridgeType").value;
      const recipient=($("#recipient").value||me).trim().toLowerCase();
      if(!/^0x[0-9a-fA-F]{40}$/.test(recipient)) throw new Error("Alamat penerima tidak valid.");

      if(mode==="lz"){
        // ===== SafeSend (anti invalid BigNumber) =====
        const adapter=$("#lzAdapter").value.trim();
        const dstEidStr=$("#lzDstEid").value.trim();
        const decimals=parseInt($("#lzDecimals").value||"6",10);
        const amountStr=$("#amount").value.trim();

        if(!dstEidStr||isNaN(Number(dstEidStr))) throw new Error("dstEid tidak valid.");
        if(!amountStr||isNaN(Number(amountStr))) throw new Error("Jumlah tidak valid.");

        const dstEid = ethers.BigNumber.from(String(dstEidStr));
        const amountLD = ethers.BigNumber.from(ethers.utils.parseUnits(String(amountStr), decimals));
        const to32 = addrTo32(recipient);

        const sendParam = {
          dstEid: dstEid,
          to: to32,
          amountLD: amountLD,
          minAmountLD: amountLD,
          extraOptions: "0x",
          composeMsg: "0x",
          oftCmd: "0x"
        };

        log(`üöÄ LZ send validated ‚úÖ
dstEid: ${dstEid.toString()}
to: ${to32}
amountLD: ${amountLD.toString()}`);

        const oft=new ethers.Contract(adapter,OFT_ABI,signer);
        const fee=await oft.quoteSend(sendParam,false);
        const feeStruct={
          nativeFee: fee.nativeFee || ethers.BigNumber.from(0),
          zroFee: ethers.BigNumber.from(0)
        };
        log(`üí∞ Fee estimate: ${ethers.utils.formatEther(fee.nativeFee)} ETH`);

        const tx=await oft.send(sendParam,feeStruct,me,{value:fee.nativeFee,gasLimit:300000});
        log(`‚è≥ TX: ${tx.hash}`); await tx.wait();
        log("‚úÖ Bridge (OFT) sukses! Tunggu penerimaan di Stable testnet.");
      } else {
        // Wormhole opsional
        const whBridge=$("#whBridge").value.trim();
        const token=$("#whToken").value.trim();
        const dec=parseInt($("#whDec").value||"6",10);
        const dstChain=parseInt($("#whDst").value||"0",10);
        if(!dstChain) throw new Error("Isi dst Wormhole chainID terlebih dulu.");
        const amountLD=parseAmount($("#amount").value.trim(),dec);
        const bridge=new ethers.Contract(whBridge,["function transferTokens(address,uint256,uint16,bytes32,uint256,uint32)"],signer);
        log(`üöÄ WH transferTokens ke chain ${dstChain}...`);
        const nonce=Math.floor(Math.random()*1e9);
        const tx=await bridge.transferTokens(token,amountLD,dstChain,addrTo32(recipient),0,nonce,{gasLimit:300000});
        log(`‚è≥ TX: ${tx.hash}`); await tx.wait();
        log("‚úÖ Bridge (Wormhole) sukses!");
      }
    }catch(e){
      const msg=(e.error&&e.error.message)||e.reason||e.message||String(e);
      log("‚ùå Bridge error: "+msg);
      toast("Bridge gagal","error");
      if(/invalid BigNumber value/i.test(msg)) log("üîé Debug: cek dstEid/amount/to32 terisi & bertipe benar.");
      if(/execution reverted/i.test(msg)) log("üí° Hint: periksa dstEid/adapter/token & saldo/allowance.");
    }
  };
}
</script>
</body>
</html>
