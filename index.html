<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THDX ‚Ä¢ LayerZero Bridge v5.3.5</title>
<meta name="theme-color" content="#0b1220">
<style>
body {
  margin: 0; min-height: 100vh; display: grid; place-items: center;
  background: radial-gradient(circle at top,#0f1222,#06080f);
  color: #e6edf3; font-family: system-ui, Arial, sans-serif;
}
.card {
  background: #121726; border: 1px solid #22304a; border-radius: 16px;
  padding: 28px; width: min(480px, 90vw); text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,.45);
}
h1 { color: #7c5cff; margin-top: 0; }
button {
  width: 100%; padding: 12px; border: 0; border-radius: 10px;
  font-weight: 700; color: #fff; cursor: pointer; margin-top: 10px;
  font-size: 15px; transition: .2s;
}
button.primary { background: linear-gradient(90deg,#6ee7ff,#7c5cff); }
button.ok { background: linear-gradient(90deg,#22c55e,#16a34a); }
input {
  width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px;
  border: 1px solid #22304a; background: #0f1524; color: #fff;
  font-size: 14px;
}
pre {
  white-space: pre-wrap; background: #0e1422; border: 1px solid #22304a;
  border-radius: 10px; padding: 12px; margin-top: 14px; text-align: left;
  font-size: 13px; color: #cdd6e1; min-height: 110px;
}
</style>
</head>
<body>
  <div class="card">
    <h1>üåâ THDX Bridge</h1>
    <p>LayerZero ‚Ä¢ Sepolia ‚Üí Stable Testnet</p>
    <input id="adapter" placeholder="Adapter (OFT)" value="0xc099cD946d5efCC35A99D64E808c1430cEf08126" />
    <input id="token" placeholder="Token (ERC20)" value="0xc4DCC311c028e341fd8602D8eB89c5de94625927" />
    <input id="dstEid" placeholder="dstEid (contoh: 40374)" value="40374" />
    <input id="amount" type="number" placeholder="Jumlah token (misal 10)" />
    <input id="recipient" placeholder="Alamat tujuan (otomatis terisi)" />
    <button id="connect" class="primary">üîå Connect Wallet</button>
    <button id="approve" class="primary" disabled>‚úÖ Approve</button>
    <button id="bridge" class="ok" disabled>üöÄ Bridge Now</button>
    <pre id="log">log siap...</pre>
  </div>

  <script>
  (function loadEthers(){
    const add=(src,cb)=>{const s=document.createElement('script');s.src=src;s.onload=cb;document.body.appendChild(s)};
    if(typeof window.ethers==="undefined"){
      add("https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js",initTHDX);
    }else initTHDX();
  })();

  function initTHDX(){
    const log=(m)=>{const el=document.getElementById("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m);}
    const ERC20_ABI=["function approve(address,uint256) returns(bool)"];
    const OFT_ABI=[
      "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool)view returns(uint256 nativeFee,uint256 zroFee)",
      "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address)payable"
    ];
    let provider,signer,me;

    async function connect(){
      try{
        if(!window.ethereum)throw new Error("Buka dengan MetaMask / OKX / Trust Wallet");
        provider=new ethers.providers.Web3Provider(window.ethereum,"any");
        await provider.send("eth_requestAccounts",[]);
        signer=provider.getSigner();me=await signer.getAddress();
        document.getElementById("recipient").value=me;
        const net=await provider.getNetwork();
        log(`‚úÖ Connected: ${me}\nChain: ${net.chainId}`);
        document.getElementById("approve").disabled=false;
        document.getElementById("bridge").disabled=false;
      }catch(e){log("‚ùå Connect error: "+(e.message||e));}
    }

    async function approve(){
      try{
        const token=document.getElementById("token").value.trim();
        const adapter=document.getElementById("adapter").value.trim();
        const amountStr=document.getElementById("amount").value.trim();
        if(!amountStr)return log("‚ö†Ô∏è Masukkan jumlah token.");
        const amount=ethers.utils.parseUnits(amountStr,"6");
        const erc20=new ethers.Contract(token,ERC20_ABI,signer);
        log("üßæ Approve LZ... ‚è≥");
        const tx=await erc20.approve(adapter,amount);
        log(`‚è≥ Approve TX: ${tx.hash}`);
        await tx.wait();
        log("‚úÖ Approve sukses!");
      }catch(e){log("‚ùå Approve error: "+(e.message||e));}
    }

    async function bridgeNow(){
      try{
        const adapter=document.getElementById("adapter").value.trim();
        const dstEidStr=document.getElementById("dstEid").value.trim();
        const amountStr=document.getElementById("amount").value.trim();
        const recipient=(document.getElementById("recipient").value.trim()||me).toLowerCase();
        if(!amountStr)return log("‚ö†Ô∏è Masukkan jumlah token.");

        const dstEid=Number(dstEidStr);
        const amountLD=ethers.utils.parseUnits(amountStr,"6");
        const to32="0x"+recipient.replace(/^0x/,"").padStart(64,"0");
        const oft=new ethers.Contract(adapter,OFT_ABI,signer);

        // ‚úÖ Tuple as ARRAY (fix invalid BigNumber)
        const sendParamArr=[dstEid,to32,amountLD,amountLD,"0x","0x","0x"];

        log(`1Ô∏è‚É£ Estimating fee...`);
        const fee=await oft.quoteSend(sendParamArr,false);

        // ‚úÖ Safe BigNumber parser
        const parseFee=(feeObj)=>{
          try{
            if(!feeObj)throw new Error("Fee kosong");
            if(ethers.BigNumber.isBigNumber(feeObj))return feeObj;
            if(typeof feeObj==="string"&&feeObj.startsWith("0x"))return ethers.BigNumber.from(feeObj);
            if(typeof feeObj==="object"&&feeObj._hex)return ethers.BigNumber.from(feeObj._hex);
            if(Array.isArray(feeObj))return parseFee(feeObj[0]);
            if(feeObj.nativeFee)return parseFee(feeObj.nativeFee);
            throw new Error("Format fee tidak dikenali");
          }catch(err){throw new Error("Parsing fee gagal: "+err.message);}
        };

        const nativeFee=parseFee(fee);
        const feeStructArr=[nativeFee,ethers.BigNumber.from(0)];
        const senderAddr=await signer.getAddress();

        log(`üí∞ Fee: ${ethers.utils.formatEther(nativeFee)} ETH`);
        log(`2Ô∏è‚É£ Sending transaction...`);
        const tx=await oft.send(sendParamArr,feeStructArr,senderAddr,{value:nativeFee,gasLimit:350000});
        log(`‚è≥ TX: ${tx.hash}`);
        await tx.wait();
        log(`‚úÖ Bridge sukses! üéâ Token akan muncul di Stable Testnet.`);
      }catch(e){
        const msg=(e.error&&e.error.message)||e.reason||e.message||String(e);
        log("‚ùå Bridge error: "+msg);
      }
    }

    document.getElementById("connect").onclick=connect;
    document.getElementById("approve").onclick=approve;
    document.getElementById("bridge").onclick=bridgeNow;
  }
  </script>
</body>
</html>
