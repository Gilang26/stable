<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>THDX ‚Ä¢ LayerZero Bridge v5.3.3</title>
<meta name="theme-color" content="#0b1220">
<style>
:root {
  --bg:#0b0e17;--card:#121726;--stroke:#222c42;
  --text:#e6edf3;--accent1:#7c5cff;--accent2:#6ee7ff;
  --ok1:#22c55e;--err:#ef4444;
}
*{box-sizing:border-box}
body {
  margin:0;min-height:100svh;display:grid;place-items:center;
  background:radial-gradient(circle at top,#0f1222,#06080f);
  color:var(--text);font-family:Inter,system-ui,Arial,sans-serif;
}
.card {
  width:min(480px,90vw);background:var(--card);
  border:1px solid var(--stroke);border-radius:16px;
  padding:28px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.45);
  backdrop-filter:blur(10px);
}
h1{
  color:var(--accent1);margin:0;font-size:24px;font-weight:700;
  background:linear-gradient(90deg,var(--accent1),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
p.sub{color:#9aa6b2;margin:6px 0 18px}
label{display:block;text-align:left;margin:10px 0 4px;font-size:13px;font-weight:600}
input{
  width:100%;padding:12px;border-radius:10px;border:1px solid var(--stroke);
  background:#0f1524;color:#fff;font-size:14px
}
button{
  width:100%;padding:12px;margin-top:10px;border:0;border-radius:10px;
  color:#fff;font-weight:700;cursor:pointer;transition:.2s;font-size:15px
}
button.primary{background:linear-gradient(90deg,var(--accent2),var(--accent1))}
button.ok{background:linear-gradient(90deg,#22c55e,#16a34a)}
button:disabled{opacity:.55;cursor:not-allowed}
pre{
  background:#0e1422;border:1px solid var(--stroke);border-radius:10px;
  padding:12px;margin-top:12px;font-size:12.5px;white-space:pre-wrap;text-align:left;
  color:#d0d8e6;min-height:110px;
}
.loading{animation:blink 1s linear infinite}
@keyframes blink{50%{opacity:.3}}
#footer{margin-top:18px;color:#707d93;font-size:12px}
#footer b{color:var(--accent1)}
</style>
</head>
<body>
<div class="card">
  <h1>THDX Bridge</h1>
  <p class="sub">LayerZero ‚Ä¢ Sepolia ‚Üí Stable Testnet</p>

  <label>Adapter OFT (LayerZero)</label>
  <input id="adapter" value="0xc099cD946d5efCC35A99D64E808c1430cEf08126">

  <label>Token (Sepolia)</label>
  <input id="token" value="0xc4DCC311c028e341fd8602D8eB89c5de94625927">

  <label>dstEid</label>
  <input id="dstEid" value="40374">

  <label>Jumlah Token</label>
  <input id="amount" placeholder="mis: 10" inputmode="decimal">

  <label>Penerima</label>
  <input id="recipient" placeholder="0x... (otomatis terisi)" />

  <button id="connect" class="primary">üîå Connect Wallet</button>
  <button id="approve" class="primary" disabled>‚úÖ Approve</button>
  <button id="bridge" class="ok" disabled>üöÄ Bridge Now</button>

  <pre id="log">log siap...</pre>
  <div id="footer">Powered by <b>LayerZero</b> ‚Ä¢ Built by <b>THDX</b></div>
</div>

<script>
(function loadEthers(){
  const add=(src,cb)=>{const s=document.createElement('script');s.src=src;s.onload=cb;document.body.appendChild(s)};
  if(typeof window.ethers==="undefined"){
    add("https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js",initTHDX);
  }else initTHDX();
})();

function initTHDX(){
  const log=(m)=>{const el=document.getElementById("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m);}
  const addr32=(a)=>"0x"+a.slice(2).padStart(64,"0");
  const ERC20_ABI=["function approve(address,uint256) returns(bool)"];
  const OFT_ABI=[
    "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),bool)view returns(uint256 nativeFee,uint256 zroFee)",
    "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address)payable"
  ];
  let provider,signer,me;

  async function connect(){
    try{
      if(!window.ethereum)throw new Error("Buka dengan MetaMask / OKX / Trust Wallet");
      provider=new ethers.providers.Web3Provider(window.ethereum,"any");
      await provider.send("eth_requestAccounts",[]);
      signer=provider.getSigner();me=await signer.getAddress();
      document.getElementById("recipient").value=me;
      const net=await provider.getNetwork();
      log(`‚úÖ Connected: ${me}\nChain: ${net.chainId}`);
      document.getElementById("approve").disabled=false;
      document.getElementById("bridge").disabled=false;
    }catch(e){log("‚ùå Connect error: "+(e.message||e));}
  }

  async function approve(){
    try{
      const token=document.getElementById("token").value.trim();
      const adapter=document.getElementById("adapter").value.trim();
      const amountStr=document.getElementById("amount").value.trim();
      if(!amountStr)return log("‚ö†Ô∏è Masukkan jumlah token.");
      const amount=ethers.utils.parseUnits(amountStr,"6");
      const erc20=new ethers.Contract(token,ERC20_ABI,signer);
      log("üßæ Approve LZ... ‚è≥");
      const tx=await erc20.approve(adapter,amount);
      log(`‚è≥ Approve TX: ${tx.hash}`);
      await tx.wait();
      log("‚úÖ Approve sukses!");
    }catch(e){log("‚ùå Approve error: "+(e.message||e));}
  }

  async function bridgeNow(){
    try{
      const adapter=document.getElementById("adapter").value.trim();
      const dstEidStr=document.getElementById("dstEid").value.trim();
      const amountStr=document.getElementById("amount").value.trim();
      const recipient=document.getElementById("recipient").value.trim()||me;
      if(!amountStr)return log("‚ö†Ô∏è Masukkan jumlah token.");
      const dstEid=Number(dstEidStr);
      const amountLD=ethers.utils.parseUnits(amountStr,"6");
      const to32=addr32(recipient);
      const oft=new ethers.Contract(adapter,OFT_ABI,signer);
      const sendParam={dstEid,to:to32,amountLD,minAmountLD:amountLD,extraOptions:"0x",composeMsg:"0x",oftCmd:"0x"};
      log(`1Ô∏è‚É£ Estimating fee...`);

      const fee=await oft.quoteSend(sendParam,false);
      // === Force Deep Decode ===
      const extractDeep=(x)=>{
        if(!x)return null;
        if(ethers.BigNumber.isBigNumber(x))return x;
        if(typeof x==="string")return x;
        if(typeof x==="object"){
          if(x._hex)return x._hex;
          const vals=Object.values(x);
          for(const v of vals){
            const res=extractDeep(v);
            if(res)return res;
          }
        }
        return null;
      };
      const nativeFeeRaw=extractDeep(fee);
      if(!nativeFeeRaw)throw new Error("Gagal membaca nativeFee dari kontrak.");

      const nativeFee=ethers.BigNumber.from(
        ethers.BigNumber.isBigNumber(nativeFeeRaw)
          ? nativeFeeRaw
          : (typeof nativeFeeRaw==="string"?nativeFeeRaw:nativeFeeRaw.toString())
      );

      const feeStruct=[nativeFee,ethers.BigNumber.from(0)];
      const senderAddr=await signer.getAddress();
      log(`üí∞ Fee: ${ethers.utils.formatEther(nativeFee)} ETH`);
      log(`2Ô∏è‚É£ Sending transaction...`);
      const tx=await oft.send(sendParam,feeStruct,senderAddr,{value:nativeFee,gasLimit:350000});
      log(`‚è≥ TX: ${tx.hash}`);
      await tx.wait();
      log(`‚úÖ Bridge sukses! üéâ Token akan muncul di Stable Testnet.`);
    }catch(e){
      const msg=(e.error&&e.error.message)||e.reason||e.message||String(e);
      log("‚ùå Bridge error: "+msg);
    }
  }

  document.getElementById("connect").onclick=connect;
  document.getElementById("approve").onclick=approve;
  document.getElementById("bridge").onclick=bridgeNow;
}
</script>
</body>
</html>
